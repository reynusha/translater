<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qentrum</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #48484a;
            --accent-blue: #2ea6ff;
            --accent-green: #34c759;
            --accent-purple: #bf5af2;
            --accent-online: #34c759;
            --accent-offline: #ff453a;
            --border-color: #38383a;
            --message-out: #2b5278;
            --message-in: #1e2c3a;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            max-width: 100%;
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            position: relative;
            overflow: hidden;
        }

        .welcome-background {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(191, 90, 242, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(46, 166, 255, 0.1) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        .welcome-logo {
            font-size: 52px;
            font-weight: 800;
            background: linear-gradient(135deg, #bf5af2 0%, #2ea6ff 50%, #34c759 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
            position: relative;
            z-index: 2;
        }

        .welcome-subtitle {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 40px;
            position: relative;
            z-index: 2;
        }

        .welcome-content {
            max-width: 400px;
            position: relative;
            z-index: 2;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #ffffff 0%, #bf5af2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .feature-list {
            text-align: left;
            margin-bottom: 40px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .feature-item {
            margin-bottom: 16px;
            padding-left: 24px;
            position: relative;
        }

        .feature-item:before {
            content: "";
            width: 6px;
            height: 6px;
            background: var(--accent-purple);
            border-radius: 50%;
            position: absolute;
            left: 8px;
            top: 8px;
        }

        .start-button {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            width: 100%;
            max-width: 300px;
        }

        .start-button:active {
            opacity: 0.8;
            transform: scale(0.98);
        }

        .legal-text {
            font-size: 12px;
            color: var(--text-tertiary);
            max-width: 300px;
            line-height: 1.4;
        }

        .legal-link {
            color: var(--accent-blue);
            text-decoration: none;
        }

        /* Main App */
        .main-app {
            display: none;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 17px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 16px;
        }

        .header-icon {
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-icon:active {
            opacity: 1;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }

        /* Content */
        .content {
            flex: 1;
            overflow: hidden;
            display: flex;
        }

        .tab-content {
            flex: 1;
            display: none;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        /* Chats List */
        .chats-list {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .search-container {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
        }

        .chat-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-item:active {
            background-color: var(--bg-secondary);
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #bf5af2 0%, #2ea6ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
            position: relative;
        }

        .online-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
        }

        .online-status.online {
            background: var(--accent-online);
        }

        .online-status.offline {
            background: var(--accent-offline);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-username {
            font-size: 14px;
            color: var(--accent-blue);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-last-message {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Chat Window */
        .chat-window {
            flex: 1;
            display: none;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-button {
            background: none;
            border: none;
            color: var(--accent-blue);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            margin-right: 4px;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #bf5af2 0%, #2ea6ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            position: relative;
        }

        .chat-header-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header-name {
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-status {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.outgoing {
            align-self: flex-end;
            background: var(--message-out);
            border-bottom-right-radius: 4px;
        }

        .message.incoming {
            align-self: flex-start;
            background: var(--message-in);
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            text-align: right;
        }

        .message-input-container {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: var(--bg-primary);
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 44px;
            font-family: inherit;
            transition: border-color 0.2s ease;
        }

        .message-input:focus {
            border-color: var(--accent-blue);
        }

        .send-button {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 16px;
        }

        .send-button:active {
            opacity: 0.8;
            transform: scale(0.95);
        }

        .send-button:disabled {
            background: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        /* Profile */
        .profile-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px;
        }

        .profile-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #bf5af2 0%, #2ea6ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 600;
            color: white;
            margin: 0 auto 20px;
            cursor: pointer;
            border: 4px solid var(--bg-primary);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .profile-avatar-large:active {
            transform: scale(0.95);
        }

        .profile-name {
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .profile-username {
            text-align: center;
            font-size: 16px;
            color: var(--accent-blue);
            margin-bottom: 8px;
            word-break: break-word;
        }

        .profile-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 15px;
            margin-bottom: 12px;
            outline: none;
            font-family: inherit;
        }

        .profile-save {
            width: 100%;
            padding: 12px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .profile-save:active {
            opacity: 0.8;
        }

        .info-box {
            background: rgba(191, 90, 242, 0.1);
            border: 1px solid var(--accent-purple);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-size: 14px;
            line-height: 1.4;
            color: var(--accent-purple);
        }

        /* Loading and States */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-title {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-subtitle {
            font-size: 14px;
            opacity: 0.7;
        }

        /* Transition animations */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcome-screen">
        <div class="welcome-background"></div>
        <div class="welcome-content">
            <div class="welcome-logo">Qentrum</div>
            <div class="welcome-subtitle">Next Level Communication</div>
            
            <div class="welcome-title">Welcome to Qentrum</div>
            
            <div class="feature-list">
                <div class="feature-item">Instant messaging with quantum-level security and privacy</div>
                <div class="feature-item">Your Telegram identity seamlessly integrated</div>
                <div class="feature-item">Real-time online status and read receipts</div>
                <div class="feature-item">Collectible usernames and digital identity</div>
            </div>
            
            <button class="start-button" id="start-button">
                Get Started
            </button>
            
            <div class="legal-text">
                By continuing, you agree to our Terms of Service and Privacy Policy
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="main-app" id="main-app">
        <!-- Header -->
        <div class="header">
            <div class="header-title" id="header-title">Chats</div>
            <div class="header-actions">
                <div class="header-icon" id="search-button">
                    <i class="fas fa-search"></i>
                </div>
                <div class="header-icon" id="new-chat-button">
                    <i class="fas fa-edit"></i>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('chats')">Chats</button>
            <button class="tab" onclick="switchTab('profile')">Profile</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Chats Tab -->
            <div id="chats-tab" class="tab-content active">
                <div class="chats-list">
                    <div class="search-container">
                        <input type="text" class="search-input" placeholder="Search users by name or username" id="user-search">
                    </div>
                    <div id="chats-container">
                        <div class="empty-state">
                            <div class="empty-title">No conversations yet</div>
                            <div class="empty-subtitle">Search for users to start chatting</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-content">
                <div class="profile-content">
                    <div class="profile-section">
                        <div class="profile-avatar-large" id="profile-avatar-large">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-name" id="profile-name">Loading...</div>
                        <div class="profile-username" id="profile-username">@username</div>
                        
                        <input type="text" class="profile-input" id="username-input" placeholder="Set your username (4-10 letters)" maxlength="10">
                        <button class="profile-save" onclick="updateUsername()">Save Username</button>
                        
                        <div class="info-box">
                            Coming soon: Usernames will become collectible digital assets that can be traded and sold in our marketplace.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <div class="chat-window" id="chat-window">
        <div class="chat-header">
            <button class="back-button" onclick="closeChat()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-header-avatar" id="chat-header-avatar">
                <div class="online-status" id="chat-online-status"></div>
            </div>
            <div class="chat-header-info">
                <div class="chat-header-name" id="chat-header-name">User</div>
                <div class="chat-header-status" id="chat-header-status">Online</div>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            <div class="empty-state">
                <div class="empty-title">No messages yet</div>
                <div class="empty-subtitle">Send a message to start the conversation</div>
            </div>
        </div>
        
        <div class="message-input-container">
            <textarea class="message-input" placeholder="Type a message..." id="message-input" rows="1"></textarea>
            <button class="send-button" id="send-button" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        class QentrumMessenger {
            constructor() {
                this.currentUser = null;
                this.users = new Map();
                this.chats = new Map();
                this.currentChat = null;
                this.tg = null;
                this.onlineUsers = new Set();
                
                this.init();
            }

            init() {
                this.tg = window.Telegram.WebApp;
                this.tg.expand();
                this.tg.enableClosingConfirmation();
                
                this.loadUsers();
                this.loadChats();
                this.setupEventListeners();
                this.showWelcomeScreen();
                
                // Simulate some users being online
                setInterval(() => {
                    this.updateOnlineStatus();
                }, 30000);
            }

            setupEventListeners() {
                // Search functionality
                document.getElementById('user-search').addEventListener('input', (e) => {
                    this.searchUsers(e.target.value);
                });

                // Message input auto-resize and send on Enter
                const messageInput = document.getElementById('message-input');
                messageInput.addEventListener('input', (e) => {
                    this.autoResizeTextarea(e.target);
                    this.updateSendButton();
                });

                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Start button
                document.getElementById('start-button').addEventListener('click', () => {
                    this.startMessenger();
                });

                // Profile avatar click
                document.getElementById('profile-avatar-large').addEventListener('click', () => {
                    this.changeAvatar();
                });
            }

            showWelcomeScreen() {
                document.getElementById('welcome-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('chat-window').style.display = 'none';
            }

            startMessenger() {
                const user = this.tg.initDataUnsafe?.user;
                if (user) {
                    this.handleTelegramUser(user);
                } else {
                    // Create demo user for testing outside Telegram
                    this.createDemoUser();
                }
                
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                document.getElementById('main-app').classList.add('fade-in');
            }

            createDemoUser() {
                const demoUser = {
                    id: 'demo_user',
                    firstName: 'Telegram',
                    lastName: 'User',
                    username: 'telegramuser',
                    avatar: 'T',
                    isOnline: true
                };
                this.handleTelegramUser(demoUser);
            }

            handleTelegramUser(tgUser) {
                const userId = tgUser.id?.toString() || 'demo_user';
                
                const userData = {
                    id: userId,
                    firstName: tgUser.first_name || 'Telegram',
                    lastName: tgUser.last_name || 'User',
                    username: tgUser.username || '',
                    avatar: (tgUser.first_name?.charAt(0) || 'T').toUpperCase(),
                    isOnline: true,
                    lastSeen: Date.now()
                };

                let existingUser = this.users.get(userId);
                if (existingUser) {
                    Object.assign(existingUser, userData);
                } else {
                    this.users.set(userId, userData);
                }

                this.currentUser = this.users.get(userId);
                this.onlineUsers.add(userId);
                this.saveUsers();
                this.updateProfile();
                
                // Create some demo contacts
                this.createDemoContacts();
            }

            createDemoContacts() {
                const contacts = [
                    { id: 'user1', firstName: 'Alex', lastName: 'Johnson', username: 'alexj', avatar: 'A', isOnline: true },
                    { id: 'user2', firstName: 'Sarah', lastName: 'Miller', username: 'sarahm', avatar: 'S', isOnline: false },
                    { id: 'user3', firstName: 'Mike', lastName: 'Davis', username: 'miked', avatar: 'M', isOnline: true },
                    { id: 'user4', firstName: 'Emma', lastName: 'Wilson', username: 'emmaw', avatar: 'E', isOnline: true }
                ];

                contacts.forEach(contact => {
                    if (!this.users.has(contact.id)) {
                        this.users.set(contact.id, {
                            ...contact,
                            lastSeen: Date.now() - (contact.isOnline ? 0 : 3600000) // 1 hour ago if offline
                        });
                    }
                });

                this.saveUsers();
            }

            autoResizeTextarea(textarea) {
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            updateSendButton() {
                const messageInput = document.getElementById('message-input');
                const sendButton = document.getElementById('send-button');
                sendButton.disabled = messageInput.value.trim().length === 0;
            }

            updateOnlineStatus() {
                // Simulate online status changes
                this.users.forEach((user, userId) => {
                    if (userId !== this.currentUser?.id) {
                        const shouldBeOnline = Math.random() > 0.3; // 70% chance to be online
                        user.isOnline = shouldBeOnline;
                        user.lastSeen = Date.now();
                    }
                });
                
                if (this.currentChat) {
                    this.updateChatHeader();
                }
            }

            loadUsers() {
                try {
                    const savedUsers = localStorage.getItem('qentrum_users');
                    if (savedUsers) {
                        const usersArray = JSON.parse(savedUsers);
                        this.users = new Map(usersArray);
                    }
                } catch (error) {
                    console.log('Error loading users:', error);
                    this.users = new Map();
                }
            }

            loadChats() {
                try {
                    const savedChats = localStorage.getItem('qentrum_chats');
                    if (savedChats) {
                        const chatsArray = JSON.parse(savedChats);
                        this.chats = new Map(chatsArray);
                    } else {
                        this.chats = new Map();
                    }
                } catch (error) {
                    console.log('Error loading chats:', error);
                    this.chats = new Map();
                }
            }

            saveUsers() {
                try {
                    localStorage.setItem('qentrum_users', JSON.stringify([...this.users]));
                } catch (error) {
                    console.log('Error saving users:', error);
                }
            }

            saveChats() {
                try {
                    localStorage.setItem('qentrum_chats', JSON.stringify([...this.chats]));
                } catch (error) {
                    console.log('Error saving chats:', error);
                }
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');

                const titles = {
                    'chats': 'Chats',
                    'profile': 'Profile'
                };
                document.getElementById('header-title').textContent = titles[tabName];
            }

            searchUsers(query) {
                const chatsContainer = document.getElementById('chats-container');
                
                if (!query) {
                    chatsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-title">No conversations yet</div>
                            <div class="empty-subtitle">Search for users to start chatting</div>
                        </div>
                    `;
                    return;
                }

                const searchTerm = query.toLowerCase();
                const results = Array.from(this.users.entries())
                    .filter(([id, user]) => {
                        if (id === this.currentUser?.id) return false;
                        
                        const nameMatch = user.firstName.toLowerCase().includes(searchTerm) ||
                                         user.lastName.toLowerCase().includes(searchTerm);
                        const usernameMatch = user.username && user.username.toLowerCase().includes(searchTerm);
                        
                        return nameMatch || usernameMatch;
                    })
                    .slice(0, 10);

                if (results.length === 0) {
                    chatsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-title">No users found</div>
                            <div class="empty-subtitle">Try a different search term</div>
                        </div>
                    `;
                    return;
                }

                chatsContainer.innerHTML = results.map(([id, user]) => `
                    <div class="chat-item" onclick="messenger.openChat('${id}')">
                        <div class="chat-avatar">
                            ${user.avatar}
                            <div class="online-status ${user.isOnline ? 'online' : 'offline'}"></div>
                        </div>
                        <div class="chat-info">
                            <div class="chat-name">${user.firstName} ${user.lastName}</div>
                            ${user.username ? `<div class="chat-username">@${user.username}</div>` : ''}
                            <div class="chat-last-message">${user.isOnline ? 'Online' : 'Offline'}</div>
                        </div>
                    </div>
                `).join('');
            }

            openChat(userId) {
                if (!this.users.has(userId) || !this.currentUser) return;

                this.currentChat = userId;
                
                document.getElementById('chats-tab').style.display = 'none';
                document.getElementById('chat-window').style.display = 'flex';
                document.getElementById('chat-window').classList.add('slide-in');
                
                this.updateChatHeader();
                this.updateChatWindow();
                
                // Focus message input
                setTimeout(() => {
                    document.getElementById('message-input').focus();
                }, 300);
            }

            updateChatHeader() {
                if (!this.currentChat) return;

                const user = this.users.get(this.currentChat);
                document.getElementById('chat-header-avatar').textContent = user.avatar;
                document.getElementById('chat-header-avatar').innerHTML = user.avatar + 
                    `<div class="online-status ${user.isOnline ? 'online' : 'offline'}" id="chat-online-status"></div>`;
                document.getElementById('chat-header-name').textContent = `${user.firstName} ${user.lastName}`.trim();
                
                const status = user.isOnline ? 'Online' : this.formatLastSeen(user.lastSeen);
                document.getElementById('chat-header-status').textContent = status;
            }

            formatLastSeen(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `Last seen ${minutes} min ago`;
                if (hours < 24) return `Last seen ${hours} hour${hours > 1 ? 's' : ''} ago`;
                return `Last seen ${days} day${days > 1 ? 's' : ''} ago`;
            }

            closeChat() {
                document.getElementById('chats-tab').style.display = 'flex';
                document.getElementById('chat-window').style.display = 'none';
                this.currentChat = null;
                document.getElementById('header-title').textContent = 'Chats';
                document.getElementById('user-search').value = '';
                this.searchUsers('');
            }

            updateChatWindow() {
                const messagesContainer = document.getElementById('messages-container');
                
                if (!this.currentChat) {
                    messagesContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-title">No messages yet</div>
                            <div class="empty-subtitle">Send a message to start the conversation</div>
                        </div>
                    `;
                    return;
                }

                const chatKey = this.getChatKey(this.currentUser.id, this.currentChat);
                const messages = this.chats.get(chatKey) || [];

                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-title">No messages yet</div>
                            <div class="empty-subtitle">Send a message to start the conversation</div>
                        </div>
                    `;
                    return;
                }

                messagesContainer.innerHTML = messages.map(msg => `
                    <div class="message ${msg.sender === this.currentUser.id ? 'outgoing' : 'incoming'}">
                        ${this.escapeHtml(msg.text)}
                        <div class="message-time">${this.formatTime(msg.timestamp)}</div>
                    </div>
                `).join('');

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            sendMessage() {
                const input = document.getElementById('message-input');
                const text = input.value.trim();
                
                if (!text || !this.currentChat || !this.currentUser) return;

                const chatKey = this.getChatKey(this.currentUser.id, this.currentChat);
                const messages = this.chats.get(chatKey) || [];

                const newMessage = {
                    text: text,
                    sender: this.currentUser.id,
                    timestamp: new Date().toISOString()
                };

                messages.push(newMessage);
                this.chats.set(chatKey, messages);
                this.saveChats();
                
                input.value = '';
                this.autoResizeTextarea(input);
                this.updateSendButton();
                this.updateChatWindow();
                
                // Simulate reply after 1-3 seconds
                setTimeout(() => {
                    this.simulateReply();
                }, 1000 + Math.random() * 2000);
            }

            simulateReply() {
                if (!this.currentChat || !this.currentUser) return;

                const replies = [
                    "Hey! How are you doing?",
                    "Thanks for your message!",
                    "That's interesting, tell me more",
                    "I was thinking the same thing",
                    "Let me check and get back to you",
                    "Sounds good to me!",
                    "What do you think about this?",
                    "I'll be available in a few minutes"
                ];

                const randomReply = replies[Math.floor(Math.random() * replies.length)];
                const chatKey = this.getChatKey(this.currentUser.id, this.currentChat);
                const messages = this.chats.get(chatKey) || [];

                messages.push({
                    text: randomReply,
                    sender: this.currentChat,
                    timestamp: new Date().toISOString()
                });

                this.chats.set(chatKey, messages);
                this.saveChats();
                this.updateChatWindow();
            }

            updateProfile() {
                if (!this.currentUser) return;

                document.getElementById('profile-avatar-large').innerHTML = '<i class="fas fa-user"></i>';
                document.getElementById('profile-name').textContent = `${this.currentUser.firstName} ${this.currentUser.lastName}`.trim();
                document.getElementById('profile-username').textContent = this.currentUser.username ? `@${this.currentUser.username}` : 'No username set';
                document.getElementById('username-input').value = this.currentUser.username || '';
            }

            updateUsername() {
                if (!this.currentUser) return;

                const newUsername = document.getElementById('username-input').value.trim();
                
                if (newUsername && !this.isUsernameValid(newUsername)) {
                    alert('Username must be 4-10 English letters only');
                    return;
                }

                // Check if username is taken by other users
                if (newUsername) {
                    const isTaken = Array.from(this.users.values()).some(user => 
                        user.username === newUsername && user.id !== this.currentUser.id
                    );

                    if (isTaken) {
                        alert('Username already taken');
                        return;
                    }
                }

                this.currentUser.username = newUsername || '';
                this.users.set(this.currentUser.id, this.currentUser);
                this.saveUsers();
                
                this.updateProfile();
                
                if (newUsername) {
                    alert('Username updated successfully!');
                } else {
                    alert('Username removed successfully!');
                }
            }

            changeAvatar() {
                if (!this.currentUser) return;

                const avatars = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                const currentAvatar = this.currentUser.avatar;
                const currentIndex = avatars.indexOf(currentAvatar);
                const newAvatar = avatars[(currentIndex + 1) % avatars.length];
                
                this.currentUser.avatar = newAvatar;
                this.users.set(this.currentUser.id, this.currentUser);
                this.saveUsers();
                this.updateProfile();
            }

            getChatKey(user1, user2) {
                return [user1, user2].sort().join('_');
            }

            isUsernameValid(username) {
                const regex = /^[a-zA-Z]{4,10}$/;
                return regex.test(username);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Global functions
        function switchTab(tabName) {
            messenger.switchTab(tabName);
        }

        function updateUsername() {
            messenger.updateUsername();
        }

        function sendMessage() {
            messenger.sendMessage();
        }

        function closeChat() {
            messenger.closeChat();
        }

        // Initialize messenger
        const messenger = new QentrumMessenger();

        // Update send button state on page load
        document.addEventListener('DOMContentLoaded', function() {
            messenger.updateSendButton();
        });
    </script>
</body>
</html>
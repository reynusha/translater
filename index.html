<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Messenger</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .app-header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .app-logo {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .app-subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .hidden {
            display: none !important;
        }

        .btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #0077bb;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: transparent;
            color: #0088cc;
            border: 1px solid #0088cc;
        }

        .btn-secondary:hover {
            background: rgba(0, 136, 204, 0.1);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s ease;
        }

        .input-field:focus {
            border-color: #0088cc;
            outline: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin-right: 15px;
        }

        .user-details {
            flex-grow: 1;
        }

        .user-name {
            font-weight: bold;
            font-size: 18px;
        }

        .user-username {
            color: #777;
            font-size: 14px;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .search-results {
            border: 1px solid #eee;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .user-result {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .user-result:hover {
            background: #f9f9f9;
        }

        .user-result:last-child {
            border-bottom: none;
        }

        .chat-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #eee;
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-header {
            padding: 15px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
            font-weight: bold;
        }

        .chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            max-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 15px;
            position: relative;
        }

        .message-sent {
            align-self: flex-end;
            background: #0088cc;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message-received {
            align-self: flex-start;
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message-sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
            background: #f9f9f9;
        }

        .chat-input {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
        }

        .send-button {
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            text-align: center;
        }

        .success-message {
            color: #2ecc71;
            font-size: 14px;
            margin-top: 5px;
            text-align: center;
        }

        .welcome-screen {
            text-align: center;
            padding: 20px 0;
        }

        .welcome-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .welcome-text {
            color: #777;
            margin-bottom: 30px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <div class="app-logo">Telegram Messenger</div>
            <div class="app-subtitle">Общайтесь с друзьями и находите новых</div>
        </div>

        <!-- Экран приветствия -->
        <div class="card" id="welcomeScreen">
            <div class="welcome-screen">
                <div class="welcome-icon">96</div>
                <div class="welcome-title">Добро пожаловать!</div>
                <div class="welcome-text">
                    Это мини-приложение для общения с другими пользователями Telegram. 
                    Вы можете найти друзей по никнейму и обмениваться сообщениями.
                </div>
                <button class="btn" id="startBtn">Начать общение</button>
            </div>
        </div>

        <!-- Экран авторизации -->
        <div class="card hidden" id="authScreen">
            <div class="user-info">
                <div class="user-avatar" id="authAvatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="authName">Пользователь</div>
                    <div class="user-username" id="authUsername">@username</div>
                </div>
            </div>
            
            <div class="input-group">
                <label class="input-label">Ваш никнейм</label>
                <input type="text" class="input-field" id="usernameInput" placeholder="Придумайте уникальный никнейм">
                <div class="error-message" id="usernameError"></div>
            </div>
            
            <button class="btn" id="registerBtn">Зарегистрироваться</button>
            <button class="btn btn-secondary" id="changeAccountBtn">Сменить аккаунт</button>
        </div>

        <!-- Основной экран приложения -->
        <div class="card hidden" id="mainScreen">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-name" id="userName">Пользователь</div>
                    <div class="user-username" id="userUsername">@username</div>
                </div>
                <button class="btn btn-secondary" id="logoutBtn" style="width: auto; padding: 8px 15px;">Выйти</button>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Поиск пользователей по никнейму">
                <div class="search-results hidden" id="searchResults">
                    <!-- Результаты поиска будут здесь -->
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-header" id="chatHeader">Выберите пользователя для общения</div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Сообщения будут здесь -->
                </div>
                <div class="chat-input-container hidden" id="chatInputContainer">
                    <input type="text" class="chat-input" id="messageInput" placeholder="Введите сообщение...">
                    <button class="send-button" id="sendMessageBtn">72</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.hide();

        // Элементы DOM
        const welcomeScreen = document.getElementById('welcomeScreen');
        const authScreen = document.getElementById('authScreen');
        const mainScreen = document.getElementById('mainScreen');
        const startBtn = document.getElementById('startBtn');
        const registerBtn = document.getElementById('registerBtn');
        const changeAccountBtn = document.getElementById('changeAccountBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const usernameInput = document.getElementById('usernameInput');
        const usernameError = document.getElementById('usernameError');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const chatMessages = document.getElementById('chatMessages');
        const chatHeader = document.getElementById('chatHeader');
        const chatInputContainer = document.getElementById('chatInputContainer');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const authAvatar = document.getElementById('authAvatar');
        const authName = document.getElementById('authName');
        const authUsername = document.getElementById('authUsername');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userUsername = document.getElementById('userUsername');

        // Данные приложения
        let currentUser = null;
        let currentChat = null;
        let users = JSON.parse(localStorage.getItem('messenger_users') || '{}');
        let messages = JSON.parse(localStorage.getItem('messenger_messages') || '{}');

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Получаем данные пользователя Telegram
            const tgUser = tg.initDataUnsafe.user;
            
            if (tgUser) {
                // Показываем данные пользователя в форме авторизации
                authAvatar.textContent = tgUser.first_name ? tgUser.first_name[0].toUpperCase() : 'U';
                authName.textContent = `${tgUser.first_name || ''} ${tgUser.last_name || ''}`.trim() || 'Пользователь Telegram';
                authUsername.textContent = `@${tgUser.username || 'user'}`;
                
                // Проверяем, есть ли пользователь в нашей базе
                const userId = tgUser.id.toString();
                if (users[userId]) {
                    // Пользователь уже зарегистрирован - авторизуем автоматически
                    currentUser = users[userId];
                    showMainScreen();
                } else {
                    // Пользователь новый - показываем экран регистрации
                    showAuthScreen();
                }
            } else {
                // Пользователь не авторизован в Telegram
                showAuthScreen();
            }
        });

        // Обработчики событий
        startBtn.addEventListener('click', function() {
            welcomeScreen.classList.add('hidden');
            const tgUser = tg.initDataUnsafe.user;
            
            if (tgUser) {
                const userId = tgUser.id.toString();
                if (users[userId]) {
                    currentUser = users[userId];
                    showMainScreen();
                } else {
                    showAuthScreen();
                }
            } else {
                showAuthScreen();
            }
        });

        registerBtn.addEventListener('click', function() {
            const username = usernameInput.value.trim();
            
            if (!username) {
                usernameError.textContent = 'Введите никнейм';
                return;
            }
            
            // Проверяем, не занят ли никнейм
            const isUsernameTaken = Object.values(users).some(user => 
                user.username.toLowerCase() === username.toLowerCase()
            );
            
            if (isUsernameTaken) {
                usernameError.textContent = 'Этот никнейм уже занят';
                return;
            }
            
            // Регистрируем пользователя
            const tgUser = tg.initDataUnsafe.user;
            const userId = tgUser.id.toString();
            
            currentUser = {
                id: userId,
                firstName: tgUser.first_name || '',
                lastName: tgUser.last_name || '',
                username: username,
                telegramUsername: tgUser.username || ''
            };
            
            users[userId] = currentUser;
            localStorage.setItem('messenger_users', JSON.stringify(users));
            
            showMainScreen();
        });

        changeAccountBtn.addEventListener('click', function() {
            // Очищаем данные текущего пользователя
            currentUser = null;
            showAuthScreen();
        });

        logoutBtn.addEventListener('click', function() {
            currentUser = null;
            showAuthScreen();
        });

        searchInput.addEventListener('input', function() {
            const query = searchInput.value.trim().toLowerCase();
            
            if (query.length < 2) {
                searchResults.classList.add('hidden');
                return;
            }
            
            // Ищем пользователей по никнейму
            const results = Object.values(users).filter(user => 
                user.username.toLowerCase().includes(query) && user.id !== currentUser.id
            );
            
            displaySearchResults(results);
        });

        sendMessageBtn.addEventListener('click', function() {
            sendMessage();
        });

        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Функции отображения экранов
        function showAuthScreen() {
            welcomeScreen.classList.add('hidden');
            authScreen.classList.remove('hidden');
            mainScreen.classList.add('hidden');
            
            // Очищаем поля
            usernameInput.value = '';
            usernameError.textContent = '';
        }

        function showMainScreen() {
            welcomeScreen.classList.add('hidden');
            authScreen.classList.add('hidden');
            mainScreen.classList.remove('hidden');
            
            // Обновляем информацию о пользователе
            userAvatar.textContent = currentUser.firstName ? currentUser.firstName[0].toUpperCase() : currentUser.username[0].toUpperCase();
            userName.textContent = `${currentUser.firstName} ${currentUser.lastName}`.trim() || currentUser.username;
            userUsername.textContent = `@${currentUser.username}`;
            
            // Очищаем поиск и чат
            searchInput.value = '';
            searchResults.classList.add('hidden');
            chatMessages.innerHTML = '';
            chatHeader.textContent = 'Выберите пользователя для общения';
            chatInputContainer.classList.add('hidden');
        }

        // Функция отображения результатов поиска
        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            
            if (results.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'user-result';
                noResults.textContent = 'Пользователи не найдены';
                searchResults.appendChild(noResults);
            } else {
                results.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-result';
                    userElement.innerHTML = `
                        <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 10px;">
                            ${user.firstName ? user.firstName[0].toUpperCase() : user.username[0].toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight: bold;">${user.firstName} ${user.lastName}</div>
                            <div style="color: #777; font-size: 14px;">@${user.username}</div>
                        </div>
                    `;
                    
                    userElement.addEventListener('click', function() {
                        openChat(user);
                    });
                    
                    searchResults.appendChild(userElement);
                });
            }
            
            searchResults.classList.remove('hidden');
        }

        // Функция открытия чата с пользователем
        function openChat(user) {
            currentChat = user;
            chatHeader.textContent = `Чат с @${user.username}`;
            chatInputContainer.classList.remove('hidden');
            
            // Загружаем историю сообщений
            loadChatHistory();
            
            // Скрываем результаты поиска
            searchResults.classList.add('hidden');
            searchInput.value = '';
        }

        // Функция загрузки истории чата
        function loadChatHistory() {
            chatMessages.innerHTML = '';
            
            const chatId = getChatId(currentUser.id, currentChat.id);
            const chatMessagesList = messages[chatId] || [];
            
            if (chatMessagesList.length === 0) {
                const noMessages = document.createElement('div');
                noMessages.style.textAlign = 'center';
                noMessages.style.color: '#777';
                noMessages.style.padding = '20px';
                noMessages.textContent = 'Нет сообщений. Начните общение!';
                chatMessages.appendChild(noMessages);
            } else {
                chatMessagesList.forEach(msg => {
                    displayMessage(msg);
                });
            }
            
            // Прокручиваем вниз
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Функция отправки сообщения
        function sendMessage() {
            const text = messageInput.value.trim();
            
            if (!text || !currentChat) {
                return;
            }
            
            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                receiverId: currentChat.id,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            // Сохраняем сообщение
            const chatId = getChatId(currentUser.id, currentChat.id);
            if (!messages[chatId]) {
                messages[chatId] = [];
            }
            messages[chatId].push(message);
            localStorage.setItem('messenger_messages', JSON.stringify(messages));
            
            // Отображаем сообщение
            displayMessage(message);
            
            // Очищаем поле ввода
            messageInput.value = '';
            
            // Прокручиваем вниз
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Функция отображения сообщения
        function displayMessage(message) {
            const messageElement = document.createElement('div');
            const isSent = message.senderId === currentUser.id;
            
            messageElement.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
            
            if (!isSent) {
                const senderElement = document.createElement('div');
                senderElement.className = 'message-sender';
                senderElement.textContent = `@${currentChat.username}`;
                messageElement.appendChild(senderElement);
            }
            
            const textElement = document.createElement('div');
            textElement.textContent = message.text;
            messageElement.appendChild(textElement);
            
            chatMessages.appendChild(messageElement);
        }

        // Вспомогательная функция для получения ID чата
        function getChatId(user1, user2) {
            return [user1, user2].sort().join('_');
        }
    </script>
</body>
</html>